<?xml version="1.0" encoding="UTF-8"?>
<container xmlns="http://symfony.com/schema/dic/services" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">
    <parameters>
        <!-- Exceptions -->
        <parameter key="rednose_framework.exceptionhandler.class">Rednose\FrameworkBundle\EventListener\ExceptionListener</parameter>

        <parameter key="rednose_framework.doctrine_listener.class">Rednose\FrameworkBundle\EventListener\DoctrineListener</parameter>
        <parameter key="rednose_framework.datetime_formatter.class">Rednose\FrameworkBundle\DateTimeFormatter\DateTimeFormatter</parameter>
        <parameter key="rednose_framework.notification.factory.class">Rednose\FrameworkBundle\Notification\NotificationFactory</parameter>

        <!-- HTML purifier -->
        <parameter key="rednose_framework.purifier.factory.class">Rednose\FrameworkBundle\Purifier\PurifierFactory</parameter>

        <!-- Locale event listener -->
        <parameter key="rednose_framework.listener.locale.class">Rednose\FrameworkBundle\EventListener\LocaleListener</parameter>

        <parameter key="rednose_framework.assigner.organization.class">Rednose\FrameworkBundle\Assigner\OrganizationAssigner</parameter>
        <parameter key="rednose_framework.listener.assign_organization.class">Rednose\FrameworkBundle\EventListener\AssignOrganizationListener</parameter>
    </parameters>

    <services>
        <!-- Exceptions -->
        <service id="rednose_framework.exceptionhandler" class="%rednose_framework.exceptionhandler.class%">
            <argument type="service" id="kernel" />
            <argument type="service" id="templating" />
            <tag name="kernel.event_listener" event="kernel.exception" method="onKernelException" priority="-64" />
        </service>

        <!-- Notifications -->
        <service id="rednose_framework.notification.factory" class="%rednose_framework.notification.factory.class%">
            <argument type="service" id="service_container"/>
        </service>

        <!-- Formatting -->
        <service id="rednose_framework.datetime_formatter" class="%rednose_framework.datetime_formatter.class%">
            <argument type="service" id="time.datetime_formatter"/>
            <call method="setRequest">
                <argument type="service" id="request" on-invalid="null" strict="false" />
            </call>
        </service>

        <!-- JMS Object constructor alias -->
        <service id="rednose_framework.doctrine_object_constructor" class="Rednose\FrameworkBundle\Serializer\Construction\DoctrineObjectConstructor" public="false">
            <argument type="service" id="doctrine"/>
            <argument type="service" id="jms_serializer.unserialize_object_constructor"/>
        </service>

        <service id="jms_serializer.object_constructor" alias="rednose_framework.doctrine_object_constructor" public="false"/>

        <service id="rednose_framework.array_collection_handler" class="Rednose\FrameworkBundle\Serializer\Handler\ArrayCollectionHandler">
            <tag name="jms_serializer.subscribing_handler" />
        </service>

        <service id="jms_serializer.array_collection_handler" alias="rednose_framework.array_collection_handler"/>

        <!-- Doctrine event listener -->
        <service id="rednose_framework.doctrine_listener" class="%rednose_framework.doctrine_listener.class%">
            <argument type="service" id="event_dispatcher" />
            <tag name="doctrine.event_listener" event="postPersist" />
            <tag name="doctrine.event_listener" event="postUpdate" />
            <tag name="doctrine.event_listener" event="postRemove" />
        </service>

        <service id="rednose_framework.serializer_id_listener" class="Rednose\FrameworkBundle\EventListener\SerializerIdListener">
            <argument type="service" id="annotation_reader" />
            <argument type="service" id="doctrine.orm.entity_manager" />
            <tag name="jms_serializer.event_subscriber" event="serializer.post_deserialize" method="onPostDeserialize" priority="-64" />
            <tag name="jms_serializer.event_subscriber" event="serializer.pre_serialize" method="onPreSerialize" priority="-64" />
        </service>

        <service id="rednose_framework.listener.locale" class="%rednose_framework.listener.locale.class%">
            <argument type="service" id="security.context" />
            <tag name="kernel.event_listener" event="kernel.request" method="onKernelRequest"/>
        </service>

        <service id="rednose_framework.assigner.organization" class="%rednose_framework.assigner.organization.class%">
            <argument type="service" id="rednose_framework.organization_manager" />
        </service>

        <service id="rednose_framework.listener.assign_organization" class="%rednose_framework.listener.assign_organization.class%">
            <argument type="service" id="rednose_framework.assigner.organization" />
            <tag name="kernel.event_subscriber" />
        </service>

        <!-- File caching -->
        <service class="Rednose\FrameworkBundle\Cache\CacheFactory" id="rednose_framework.cache.cache_factory">
            <argument>%kernel.root_dir%</argument>
            <argument>%kernel.cache_dir%/rednose_framework</argument>
            <argument>/cache</argument>
            <argument type="service" id="router" />
        </service>

        <!-- HTML purifier / lexer -->
        <service id="rednose_framework.purifier.factory" class="%rednose_framework.purifier.factory.class%"/>
        <service id="rednose_framework.purifier" factory-method="create" factory-service="rednose_framework.purifier.factory" class="%rednose_framework.purifier.factory.class%"/>
        <service id="rednose_framework.purifier.lexer" factory-method="createLexer" factory-service="rednose_framework.purifier.factory" class="%rednose_framework.purifier.factory.class%"/>

        <service id="rednose_framework.organization_param_converter" class="Rednose\FrameworkBundle\Request\ParamConverter\OrganizationParamConverter">
            <argument type="service" id="rednose_framework.organization_manager" />
            <tag name="request.param_converter" converter="organization" priority="10" />
        </service>
    </services>
</container>
